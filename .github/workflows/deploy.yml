name: Deploy to Elastic Beanstalk

on:
  push:
    branches:
      - common-devlopement

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      # ----------------------------------------------------
      # Create IAM Roles (Instance Profile + Service Role)
      # ----------------------------------------------------
      - name: Create IAM roles
        run: |
          # Instance Role ------------------------------------
          if ! aws iam get-role --role-name aws-elasticbeanstalk-ec2-role >/dev/null 2>&1; then
            echo "Creating instance role..."

            aws iam create-role \
              --role-name aws-elasticbeanstalk-ec2-role \
              --assume-role-policy-document '{
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": { "Service": "ec2.amazonaws.com" },
                    "Action": "sts:AssumeRole"
                  }
                ]
              }'

            aws iam attach-role-policy \
              --role-name aws-elasticbeanstalk-ec2-role \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier

            aws iam attach-role-policy \
              --role-name aws-elasticbeanstalk-ec2-role \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkMulticontainerDocker

            aws iam attach-role-policy \
              --role-name aws-elasticbeanstalk-ec2-role \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkWorkerTier
          fi


          # EC2 Instance Profile ----------------------------------
          if ! aws iam get-instance-profile --instance-profile-name aws-elasticbeanstalk-ec2-role >/dev/null 2>&1; then
            echo "Creating instance profile..."

            aws iam create-instance-profile \
              --instance-profile-name aws-elasticbeanstalk-ec2-role

            aws iam add-role-to-instance-profile \
              --instance-profile-name aws-elasticbeanstalk-ec2-role \
              --role-name aws-elasticbeanstalk-ec2-role
          fi


          # Service Role ------------------------------------------
          if ! aws iam get-role --role-name aws-elasticbeanstalk-service-role >/dev/null 2>&1; then
            echo "Creating service role..."

            aws iam create-role \
              --role-name aws-elasticbeanstalk-service-role \
              --assume-role-policy-document '{
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": { "Service": "elasticbeanstalk.amazonaws.com" },
                    "Action": "sts:AssumeRole"
                  }
                ]
              }'

            # Correct AWS-managed policies
            aws iam attach-role-policy \
              --role-name aws-elasticbeanstalk-service-role \
              --policy-arn arn:aws:iam::aws:policy/service-role/AWSElasticBeanstalkService

            aws iam attach-role-policy \
              --role-name aws-elasticbeanstalk-service-role \
              --policy-arn arn:aws:iam::aws:policy/AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy
          fi

      # ----------------------------------------------------
      # Build & Publish .NET project
      # ----------------------------------------------------
      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build project
        run: dotnet build --configuration Release

      - name: Publish project
        run: dotnet publish -c Release -o ./publish

      # ----------------------------------------------------
      # Create ZIP for Elastic Beanstalk
      # ----------------------------------------------------
      - name: Generate deployment package
        run: |
          cd publish
          zip -r ../deploy.zip .
          cd ..

      # ----------------------------------------------------
      # Create EB Application Version + Deploy
      # ----------------------------------------------------
        - name: Upload to S3
            run: |
            BUCKET="sample-auth-api-${{ secrets.AWS_ACCOUNT_ID }}"
            echo "Uploading to $BUCKET"
            aws s3 cp deploy.zip s3://$BUCKET/deploy.zip

      - name: Create application version
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name your-eb-app \
            --version-label v-${{ github.run_id }} \
            --source-bundle S3Bucket="your-bucket-name",S3Key="deploy.zip"

      - name: Deploy to Elastic Beanstalk
        run: |
          aws elasticbeanstalk update-environment \
            --environment-name your-env-name \
            --version-label v-${{ github.run_id }}
