name: Deploy ASP.NET Core API to AWS Lambda (API Gateway integration)

on:
  push:
    branches:
      - common-devlopement
  workflow_dispatch:

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: '1'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        envtype: [development, staging, production]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Install Amazon.Lambda.Tools global tool
        run: dotnet tool install -g Amazon.Lambda.Tools --version 6.1.0 || true

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Publish
        run: dotnet publish -c Release -r linux-x64 --self-contained false -o publish

      - name: Create deployment zip
        run: |
          cd publish
          zip -r ../app.zip .
          cd ..

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Ensure LAMBDA_FUNCTION_NAME secret exists
        run: |
          if [ -z "${{ secrets.LAMBDA_FUNCTION_NAME }}" ]; then
            echo "ERROR: secret LAMBDA_FUNCTION_NAME is required";
            exit 1;
          fi

      - name: Create IAM role for Lambda (optional)
        env:
          ROLE_NAME: "${{ secrets.LAMBDA_FUNCTION_NAME }}-exec-role"
          AWS_REGION: ${{ secrets.AWS_REGION }}
          LAMBDA_ROLE_ARN: ${{ secrets.LAMBDA_ROLE_ARN }}
        run: |
          APP_NAME="Sample-AUTH-API"
          APP_NAME_LC=$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]')
          BUCKET_NAME="${APP_NAME_LC}-${{ secrets.AWS_ACCOUNT_ID }}"
          echo "Using bucket: $BUCKET_NAME"
          aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null || \
            aws s3 mb "s3://$BUCKET_NAME" --region "$AWS_REGION"
          echo "BUCKET_NAME=$BUCKET_NAME" >> $GITHUB_ENV

          if [ -z "$LAMBDA_ROLE_ARN" ]; then
            echo "No LAMBDA_ROLE_ARN provided. Please create a role manually or provide one in secrets. This workflow will not auto-create roles by default for safety.";
            exit 1
          else
            echo "LAMBDA_ROLE_ARN provided: $LAMBDA_ROLE_ARN"
          fi

      - name: Update Lambda function code
        env:
          LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
        run: |
          echo "Updating function code for $LAMBDA_FUNCTION_NAME"
          aws lambda update-function-code --function-name "$LAMBDA_FUNCTION_NAME" --zip-file fileb://app.zip

      - name: Publish new Lambda version (optional)
        if: always()
        env:
          LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
        run: |
          aws lambda publish-version --function-name "$LAMBDA_FUNCTION_NAME" || true

      - name: Create or update API Gateway HTTP API pointing to Lambda (idempotent)
        env:
          LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          FUNCTION_ARN=$(aws lambda get-function --function-name "$LAMBDA_FUNCTION_NAME" --query 'Configuration.FunctionArn' --output text)
          if [ -z "$FUNCTION_ARN" ]; then
            echo "Could not determine Lambda function ARN" && exit 1
          fi

          API_NAME="${LAMBDA_FUNCTION_NAME}-http-api-${{ matrix.envtype }}"

          EXISTING_API_ID=$(aws apigatewayv2 get-apis --query "Items[?Name=='$API_NAME'].ApiId | [0]" --output text || echo "")

          if [ "$EXISTING_API_ID" = "None" ] || [ -z "$EXISTING_API_ID" ]; then
            echo "Creating HTTP API $API_NAME"
            API_ID=$(aws apigatewayv2 create-api --name "$API_NAME" --protocol-type HTTP --target "$FUNCTION_ARN" --query 'ApiId' --output text)

            aws lambda add-permission --function-name "$LAMBDA_FUNCTION_NAME" --statement-id apigw-invoke-$API_ID --action lambda:InvokeFunction --principal apigateway.amazonaws.com --source-arn "arn:aws:execute-api:${{ secrets.AWS_REGION }}:*:$API_ID/*/*/*" || true

            ENDPOINT=$(aws apigatewayv2 get-apis --query "Items[?ApiId=='$API_ID'].ApiEndpoint" --output text)
            echo "API endpoint (${{ matrix.envtype }}): $ENDPOINT"
          else
            echo "API $API_NAME already exists with id $EXISTING_API_ID. Creating new integration to latest function."
            INTEGRATION_URI="arn:aws:apigateway:${{ secrets.AWS_REGION }}:lambda:path/2015-03-31/functions/$FUNCTION_ARN/invocations"
            INTEGRATION_ID=$(aws apigatewayv2 create-integration --api-id "$EXISTING_API_ID" --integration-type AWS_PROXY --integration-uri "$INTEGRATION_URI" --payload-format-version "2.0" --query 'IntegrationId' --output text)

            ROUTE_EXISTS=$(aws apigatewayv2 get-routes --api-id "$EXISTING_API_ID" --query 'Items[].RouteKey' --output text | grep '\$default' || true)
            if [ -z "$ROUTE_EXISTS" ]; then
              aws apigatewayv2 create-route --api-id "$EXISTING_API_ID" --route-key '$default' --target "integrations/$INTEGRATION_ID" || true
            else
              aws apigatewayv2 create-route --api-id "$EXISTING_API_ID" --route-key '$default' --target "integrations/$INTEGRATION_ID" || true
            fi

            echo "Updated integration for API $EXISTING_API_ID"
          fi

      - name: Cleanup artifact
        run: rm -f app.zip

      - name: Done
        run: echo "Deployment finished. If an API endpoint was created, check the previous step output for the URL."
