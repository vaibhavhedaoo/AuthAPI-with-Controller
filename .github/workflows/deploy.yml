name: Provision EC2 and Deploy API

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      deploy_branch:
        description: "Branch to deploy (leave blank to use default)"
        required: false
        default: ""
        type: string

      environment:
        description: "Deployment environment"
        type: choice
        options:
          - dev
          - qa
          - prod
        default: dev

      deploy_backend:
        description: "Deploy backend?"
        type: boolean
        default: true

jobs:
  provision-and-deploy:
    runs-on: ubuntu-latest

    env:
      INSTANCE_TYPE: "t3.micro"
      SSH_KEY_NAME: "auto-api-key"
      SERVICE_DIR: "/var/www/myapi"
      DOTNET_VERSION: "9.0"

    outputs:
      INSTANCE_ID: ${{ steps.use.outputs.INSTANCE_ID }}

    steps:
      - name: Checkout initial repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine deployment branch
        id: branch
        run: |
          if [ -z "${{ github.event.inputs.deploy_branch }}" ]; then
            DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
            echo "BRANCH=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "BRANCH=${{ github.event.inputs.deploy_branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout deployment branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.branch.outputs.BRANCH }}
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Resolve latest Ubuntu 22.04 AMI
        id: ami
        run: |
          AMI=$(aws ssm get-parameter --name /aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id --query "Parameter.Value" --output text)
          echo "AMI_ID=$AMI" >> $GITHUB_OUTPUT

      - name: Check for existing EC2 instance
        id: find
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=myapi" "Name=instance-state-name,Values=running,stopped" \
            --query "Reservations[0].Instances[0].InstanceId" --output text 2>/dev/null || true)
          if [ "$INSTANCE_ID" = "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "FOUND=false" >> $GITHUB_OUTPUT
          else
            echo "FOUND=true" >> $GITHUB_OUTPUT
            echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_OUTPUT
          fi

      - name: Start existing EC2 instance if needed
        if: steps.find.outputs.FOUND == 'true'
        run: |
          STATE=$(aws ec2 describe-instances --instance-ids ${{ steps.find.outputs.INSTANCE_ID }} \
            --query "Reservations[0].Instances[0].State.Name" --output text)
          if [ "$STATE" = "stopped" ]; then
            echo "Starting EC2 instance..."
            aws ec2 start-instances --instance-ids ${{ steps.find.outputs.INSTANCE_ID }}
            aws ec2 wait instance-running --instance-ids ${{ steps.find.outputs.INSTANCE_ID }}
          fi

      - name: Launch new EC2 if none found
        id: ec2
        if: steps.find.outputs.FOUND == 'false'
        run: |
          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id ${{ steps.ami.outputs.AMI_ID }} \
            --instance-type ${{ env.INSTANCE_TYPE }} \
            --key-name ${{ env.SSH_KEY_NAME }} \
            --tag-specifications 'ResourceType=instance,Tags=[{Key=Project,Value=myapi}]' \
            --query "Instances[0].InstanceId" --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Determine instance id to use
        id: use
        run: |
          if [ "${{ steps.find.outputs.FOUND }}" = "true" ]; then
            echo "INSTANCE_ID=${{ steps.find.outputs.INSTANCE_ID }}" >> $GITHUB_OUTPUT
          else
            echo "INSTANCE_ID=${{ steps.ec2.outputs.INSTANCE_ID }}" >> $GITHUB_OUTPUT
          fi

      - name: Get Public IP
        id: ip
        run: |
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-id ${{ steps.use.outputs.INSTANCE_ID }} \
            --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
          echo "EC2_HOST=$PUBLIC_IP" >> $GITHUB_OUTPUT

      - name: Output EC2 Host
        run: echo "EC2 Host is ${{ steps.ip.outputs.EC2_HOST }}"

      - name: Wait for instance status checks
        run: aws ec2 wait instance-status-ok --instance-ids ${{ steps.use.outputs.INSTANCE_ID }}

      - name: Setup EC2 dependencies
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ steps.ip.outputs.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: EC2_SSH_KEY
          script: |
            sudo apt update -y
            sudo apt install -y dotnet-sdk-9.0 nginx
            sudo systemctl enable nginx --now
            sudo mkdir -p /var/www/myapi
            sudo chown -R ubuntu:ubuntu /var/www/myapi
            sudo chmod -R 775 /var/www/myapi
            sudo tee /etc/systemd/system/myapi.service > /dev/null << 'EOF'
            [Unit]
            Description=My API Service
            After=network.target
            [Service]
            WorkingDirectory=/var/www/myapi
            ExecStart=/usr/bin/dotnet /var/www/myapi/AuthAPIwithController.dll
            Restart=always
            RestartSec=10
            KillSignal=SIGINT
            SyslogIdentifier=myapi-service
            User=ubuntu
            Environment=ASPNETCORE_ENVIRONMENT=Production
            Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false
            [Install]
            WantedBy=multi-user.target
            EOF
            sudo systemctl daemon-reload
            sudo systemctl enable myapi
            sudo systemctl restart myapi || true

      - name: Publish .NET API
        run: dotnet publish -c Release -o out

      - name: Upload build output
        if: ${{ github.event.inputs.deploy_backend }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.ip.outputs.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "out/*"
          target: "${{ env.SERVICE_DIR }}"

      # ===================== DEBUG STEP ADDED ============================
      - name: Debug myapi service logs
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ steps.ip.outputs.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "==== SYSTEMCTL STATUS ===="
            sudo systemctl status myapi --no-pager
            echo "==== JOURNALCTL LOGS (LAST 100) ===="
            sudo journalctl -u myapi --no-pager -n 100
            echo "==== LISTENING PORTS ===="
            sudo lsof -i -P -n | grep LISTEN
      # ==================================================================

      - name: Finished
        run: echo "Deployment completed successfully 🎉"
