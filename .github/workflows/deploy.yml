name: Provision EC2 and Deploy API

on:
  workflow_dispatch:
    inputs:
      deploy_branch:
        description: "Branch to deploy (leave blank to use default)"
        required: false
        default: ""
        type: string

      environment:
        description: "Deployment environment"
        type: choice
        options:
          - dev
          - qa
          - prod
        default: dev

      deploy_backend:
        description: "Deploy backend?"
        type: boolean
        default: true

jobs:
  provision-and-deploy:
    runs-on: ubuntu-latest

    env:
      INSTANCE_TYPE: "t3.micro"
      SSH_KEY_NAME: "auto-api-key"
      SERVICE_DIR: "/var/www/myapi"
      DOTNET_VERSION: "9.0"

    steps:
      - name: Checkout initial repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine deployment branch
        id: branch
        run: |
          if [ -z "${{ github.event.inputs.deploy_branch }}" ]; then
            DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
            echo "No branch provided, using default: $DEFAULT_BRANCH"
            echo "BRANCH=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "Using provided branch: ${{ github.event.inputs.deploy_branch }}"
            echo "BRANCH=${{ github.event.inputs.deploy_branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout deployment branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.branch.outputs.BRANCH }}
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Resolve latest Ubuntu 22.04 AMI
        id: ami
        run: |
          AMI=$(aws ssm get-parameter --name /aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id --query "Parameter.Value" --output text)
          echo "AMI_ID=$AMI" >> $GITHUB_OUTPUT
          echo "Using AMI: $AMI"

      - name: Create EC2 keypair
        run: |
          if aws ec2 describe-key-pairs --key-name ${{ env.SSH_KEY_NAME }} >/dev/null 2>&1; then
            echo "Key pair exists."
          else
            aws ec2 create-key-pair --key-name ${{ env.SSH_KEY_NAME }} --query "KeyMaterial" --output text > private.pem
            chmod 400 private.pem
            echo "EC2_SSH_KEY<<EOF" >> $GITHUB_ENV
            cat private.pem >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Launch EC2 instance
        id: ec2
        run: |
          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id ${{ steps.ami.outputs.AMI_ID }} \
            --instance-type ${{ env.INSTANCE_TYPE }} \
            --key-name ${{ env.SSH_KEY_NAME }} \
            --query "Instances[0].InstanceId" --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Launched EC2: $INSTANCE_ID"

      - name: Wait for EC2 running
        run: |
          aws ec2 wait instance-running --instance-ids ${{ steps.ec2.outputs.INSTANCE_ID }}
          echo "EC2 is running"

      - name: Get Public IP
        id: ip
        run: |
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-id ${{ steps.ec2.outputs.INSTANCE_ID }} \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "EC2_HOST=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "Public IP: $PUBLIC_IP"

      - name: Update EC2_HOST secret
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: publicKey } = await github.rest.actions.getRepoPublicKey({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const sodium = require("tweetsodium");
            const value = "${{ steps.ip.outputs.EC2_HOST }}";
            const keyBytes = Buffer.from(publicKey.key, "base64");
            const encryptedBytes = sodium.seal(Buffer.from(value), keyBytes);
            const encryptedValue = Buffer.from(encryptedBytes).toString("base64");

            await github.rest.actions.createOrUpdateRepoSecret({
              owner: context.repo.owner,
              repo: context.repo.repo,
              secret_name: "EC2_HOST",
              encrypted_value: encryptedValue,
              key_id: publicKey.key_id,
            });

      - name: Setup EC2 dependencies
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ steps.ip.outputs.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo apt update -y
            sudo apt install -y dotnet-sdk-9.0 nginx
            sudo systemctl enable nginx --now
            sudo mkdir -p ${{ env.SERVICE_DIR }}

      - name: Publish .NET API
        run: dotnet publish -c Release -o out

      - name: Upload build output
        if: ${{ github.event.inputs.deploy_backend }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.ip.outputs.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "out/*"
          target: "${{ env.SERVICE_DIR }}"

      - name: Finished
        run: echo "Deployment completed successfully 🎉"
