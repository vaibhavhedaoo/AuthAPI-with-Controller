name: Manual Deploy to EC2

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment to deploy"
        type: choice
        required: true
        options:
          - dev
          - qa
          - prod

      deploy_backend:
        description: "Deploy ASP.NET Core API?"
        type: boolean
        required: true
        default: true

      deploy_branch:
        description: "Select branch to deploy"
        type: string
        required: true
        default: "main"

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      DOTNET_VERSION: '8.0'       # change to your runtime if needed
      SERVICE_NAME: "myapi"
      SERVICE_DIR: "/var/www/myapi"
      APP_DLL_NAME: "YourApp.dll" # change to your DLL name

    steps:
      - name: Checkout selected branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.deploy_branch }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Publish
        run: dotnet publish -c Release -o out

      - name: Load environment-specific variables
        id: envs
        run: |
          if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
            echo "EC2_HOST=${{ secrets.EC2_DEV_HOST }}" >> $GITHUB_OUTPUT
            echo "EC2_USER=${{ secrets.EC2_DEV_USER }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" = "qa" ]; then
            echo "EC2_HOST=${{ secrets.EC2_QA_HOST }}" >> $GITHUB_OUTPUT
            echo "EC2_USER=${{ secrets.EC2_QA_USER }}" >> $GITHUB_OUTPUT
          else
            echo "EC2_HOST=${{ secrets.EC2_PROD_HOST }}" >> $GITHUB_OUTPUT
            echo "EC2_USER=${{ secrets.EC2_PROD_USER }}" >> $GITHUB_OUTPUT
          fi

      - name: Prepare EC2 server (Install .NET, create folder, systemd)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ steps.envs.outputs.EC2_HOST }}
          username: ${{ steps.envs.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "=== apt update ==="
            sudo apt-get update -y

            echo "=== Ensure curl/wget & ca-certificates present ==="
            sudo apt-get install -y wget apt-transport-https ca-certificates gnupg

            echo "=== Install dotnet-runtime-8.0 if missing ==="
            if ! command -v dotnet >/dev/null 2>&1; then
              # Add Microsoft package source (works for Ubuntu/Debian)
              wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O /tmp/packages-microsoft-prod.deb || true
              sudo dpkg -i /tmp/packages-microsoft-prod.deb || true
              sudo apt-get update -y
              sudo apt-get install -y dotnet-runtime-8.0 || true
            else
              echo "dotnet already installed: $(dotnet --version || true)"
            fi

            echo "=== Create app directory ==="
            sudo mkdir -p "${{ env.SERVICE_DIR }}"
            sudo chown -R $USER:www-data "${{ env.SERVICE_DIR }}" || true
            sudo chmod -R 755 "${{ env.SERVICE_DIR }}"

            echo "=== Write systemd service file ==="
            # Using tee + quoted heredoc to avoid nested-quote YAML issues
            sudo tee /etc/systemd/system/${{ env.SERVICE_NAME }}.service > /dev/null <<'SERVICE_EOF'
[Unit]
Description=ASP.NET Core API - $SERVICE_NAME
After=network.target

[Service]
WorkingDirectory=${{ env.SERVICE_DIR }}
ExecStart=/usr/bin/dotnet ${{ env.SERVICE_DIR }}/${{ env.APP_DLL_NAME }}
Restart=always
RestartSec=5
SyslogIdentifier=${{ env.SERVICE_NAME }}
User=www-data
Environment=ASPNETCORE_ENVIRONMENT=Production

[Install]
WantedBy=multi-user.target
SERVICE_EOF

            echo "=== Reload systemd and enable service ==="
            sudo systemctl daemon-reload
            sudo systemctl enable ${{ env.SERVICE_NAME }} || true

      - name: Deploy published files to EC2
        if: ${{ github.event.inputs.deploy_backend == 'true' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.envs.outputs.EC2_HOST }}
          username: ${{ steps.envs.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "out/*"
          target: "${{ env.SERVICE_DIR }}"

      - name: Restart service on EC2
        if: ${{ github.event.inputs.deploy_backend == 'true' }}
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ steps.envs.outputs.EC2_HOST }}
          username: ${{ steps.envs.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail
            echo "=== Restarting ${{ env.SERVICE_NAME }} ==="
            sudo systemctl restart ${{ env.SERVICE_NAME }}
            sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager || true
