name: Provision EC2 and Deploy API

on:
  workflow_dispatch:
    inputs:
      deploy_branch:
        description: "Branch to deploy"
        default: "main"
        type: string

jobs:
  provision-and-deploy:
    runs-on: ubuntu-latest

    env:
      INSTANCE_NAME: "auto-api-server"
      INSTANCE_TYPE: "t2.micro"
      AMI_ID: "ami-0f58b397bc5c1f2e8" # Ubuntu 22.04 LTS ap-south-1
      KEY_NAME: "api-key"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.deploy_branch }}

      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create EC2 Key Pair if Not Exists
        run: |
          aws ec2 describe-key-pairs --key-name ${{ env.KEY_NAME }} || \
          aws ec2 create-key-pair --key-name ${{ env.KEY_NAME }} --query 'KeyMaterial' --output text > key.pem
          chmod 400 key.pem
          echo "EC2_SSH_KEY<<EOF" >> $GITHUB_ENV
          cat key.pem >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Launch EC2 Instance
        id: ec2
        run: |
          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id ${{ env.AMI_ID }} \
            --count 1 \
            --instance-type ${{ env.INSTANCE_TYPE }} \
            --key-name ${{ env.KEY_NAME }} \
            --query "Instances[0].InstanceId" \
            --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Launched instance: $INSTANCE_ID"

      - name: Wait for EC2 to be running
        run: |
          aws ec2 wait instance-running --instance-ids ${{ steps.ec2.outputs.INSTANCE_ID }}
          echo "EC2 is running"

      - name: Get Public IP
        id: ip
        run: |
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-id ${{ steps.ec2.outputs.INSTANCE_ID }} \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "EC2_HOST=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "Public IP: $PUBLIC_IP"

      - name: Update EC2_HOST GitHub Secret
        uses: gliech/create-github-secret-action@v2
        with:
          name: EC2_HOST
          value: ${{ steps.ip.outputs.EC2_HOST }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependencies & Deploy .NET API
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ steps.ip.outputs.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo apt update -y
            sudo apt install -y dotnet-sdk-9.0 nginx
            mkdir -p /var/www/myapi
            sudo systemctl start nginx
            echo "deployment ready"
