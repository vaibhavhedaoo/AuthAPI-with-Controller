name: Deploy API to EC2

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment"
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod

      deploy_branch:
        description: "Select branch to deploy (leave blank to use default branch)"
        required: false
        default: ""
        type: string

      deploy_backend:
        description: "Deploy backend?"
        required: true
        type: boolean
        default: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      DOTNET_VERSION: "9.0"
      SERVICE_NAME: "myapi"
      SERVICE_DIR: "/var/www/myapi"
      APP_DLL_NAME: "AuthAPIwithController.dll"

    steps:
      # Determine which branch to use
      - name: Initial Checkout to determine default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine branch to deploy
        id: branch
        run: |
          if [ -z "${{ github.event.inputs.deploy_branch }}" ]; then
            DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
            echo "No branch selected, using default branch: $DEFAULT_BRANCH"
            echo "BRANCH=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "Branch selected: ${{ github.event.inputs.deploy_branch }}"
            echo "BRANCH=${{ github.event.inputs.deploy_branch }}" >> $GITHUB_OUTPUT
          fi

      # Checkout selected branch
      - name: Checkout deployment branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.branch.outputs.BRANCH }}
          fetch-depth: 0

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build project
        run: dotnet build --configuration Release --no-restore

      - name: Publish project
        run: dotnet publish -c Release -o out

      # Simplified environment resolution using same secret for all environments
      - name: Resolve EC2 Host & User values
        id: envs
        run: |
          echo "EC2_HOST=${{ secrets.EC2_HOST }}" >> $GITHUB_OUTPUT
          echo "EC2_USER=${{ secrets.EC2_USER }}" >> $GITHUB_OUTPUT
          echo "ENV_NAME=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT

      # Debugging output
      - name: Debug host and env values
        run: |
          echo "Host: ${{ steps.envs.outputs.EC2_HOST }}"
          echo "User: ${{ steps.envs.outputs.EC2_USER }}"
          echo "Environment: ${{ steps.envs.outputs.ENV_NAME }}"

      - name: Create folder and install runtime if needed
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ steps.envs.outputs.EC2_HOST }}
          username: ${{ steps.envs.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo mkdir -p ${{ env.SERVICE_DIR }}
            sudo chmod -R 755 ${{ env.SERVICE_DIR }}
            if ! command -v dotnet >/dev/null; then
              wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O /tmp/pkg.deb
              sudo dpkg -i /tmp/pkg.deb
              sudo apt-get update -y
              sudo apt-get install -y dotnet-runtime-9.0
            fi

      - name: Upload systemd service file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.envs.outputs.EC2_HOST }}
          username: ${{ steps.envs.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./systemd/myapi.service"
          target: "/tmp/"

      - name: Move and activate service file
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ steps.envs.outputs.EC2_HOST }}
          username: ${{ steps.envs.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo mv /tmp/myapi.service /etc/systemd/system/
            sudo systemctl daemon-reload

      - name: Upload build output
        if: ${{ github.event.inputs.deploy_backend }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.envs.outputs.EC2_HOST }}
          username: ${{ steps.envs.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "out/*"
          target: "${{ env.SERVICE_DIR }}"

      - name: Restart service
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ steps.envs.outputs.EC2_HOST }}
          username: ${{ steps.envs.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo systemctl restart myapi
            sudo systemctl enable myapi
            sudo systemctl status myapi --no-pager
